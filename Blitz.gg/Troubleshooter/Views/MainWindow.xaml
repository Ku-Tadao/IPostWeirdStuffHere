<Window x:Class="BlitzTroubleshooter.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:BlitzTroubleshooter.ViewModels"
        xmlns:converters="clr-namespace:BlitzTroubleshooter.Converters"
        mc:Ignorable="d"
        Title="{Binding WindowTitle, Mode=OneWay}"
        Height="800" Width="950"
        WindowStartupLocation="CenterScreen"
        AllowsTransparency="True"
        Background="Transparent"
        Style="{StaticResource MainWindowStyle}"
        d:DataContext="{d:DesignInstance Type=vm:MainViewModel, IsDesignTimeCreatable=True}">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter"/>
        <converters:InverseBooleanConverter x:Key="InverseBoolConverter"/>
        <converters:CollectionEmptyToVisibilityConverter x:Key="CollectionEmptyToVisibilityConverter"/>
    </Window.Resources>

    <Border Background="{DynamicResource AppBackgroundBrush}" 
            BorderBrush="{DynamicResource BorderBrush}" 
            BorderThickness="1"
            CornerRadius="10"
            ClipToBounds="True">
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="240"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="32"/> <!-- Custom Title Bar -->
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/> <!-- Status Bar -->
            </Grid.RowDefinitions>

            <!-- Sidebar -->
            <Border Grid.Column="0" Grid.Row="0" Grid.RowSpan="3" 
                    Background="{DynamicResource SidebarBackgroundBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="0,0,1,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="120"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- App Logo/Header -->
                    <StackPanel Grid.Row="0" VerticalAlignment="Center" HorizontalAlignment="Center">
                        <Image Source="/Assets/Troubleshooter logo.png" Width="96" Height="96" RenderOptions.BitmapScalingMode="HighQuality"/>
                    </StackPanel>

                    <!-- Navigation -->
                    <ListView x:Name="SidebarList" Grid.Row="1" 
                              Background="Transparent" BorderThickness="0"
                              SelectedIndex="0"
                              SelectionMode="Single">
                        <ListViewItem Style="{StaticResource SidebarButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource Icon.Troubleshoot}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=ListViewItem}}" 
                                      Width="18" Height="18" Stretch="Uniform" Margin="0,0,12,0"/>
                                <TextBlock Text="{DynamicResource tabHeaderTroubleshooting}" VerticalAlignment="Center" FontSize="14" FontWeight="SemiBold"/>
                            </StackPanel>
                        </ListViewItem>
                        <ListViewItem Style="{StaticResource SidebarButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource Icon.Games}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=ListViewItem}}" 
                                      Width="18" Height="18" Stretch="Uniform" Margin="0,0,12,0"/>
                                <TextBlock Text="{DynamicResource tabHeaderRunningGames}" VerticalAlignment="Center" FontSize="14" FontWeight="SemiBold"/>
                            </StackPanel>
                        </ListViewItem>
                    </ListView>
                </Grid>
            </Border>

            <!-- Title Bar -->
            <Border Grid.Column="1" Grid.Row="0" Background="Transparent" WindowChrome.IsHitTestVisibleInChrome="True">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Top">
                    <Button Content="{StaticResource Icon.Minimize}" Style="{StaticResource TitleBarButton}" Click="MinimizeButton_Click"/>
                    <Button Content="{StaticResource Icon.Close}" Style="{StaticResource CloseTitleBarButton}" Click="CloseButton_Click"/>
                </StackPanel>
            </Border>

            <!-- Main Content Area -->
            <Grid Grid.Column="1" Grid.Row="1" Margin="30">
                <TabControl Background="Transparent" BorderThickness="0" 
                            SelectedIndex="{Binding SelectedIndex, ElementName=SidebarList}">
                    <TabControl.Template>
                        <ControlTemplate TargetType="TabControl">
                            <ContentPresenter ContentSource="SelectedContent"/>
                        </ControlTemplate>
                    </TabControl.Template>

                    <!-- Troubleshoot View -->
                    <TabItem>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Margin="0,0,0,30">
                                <TextBlock Text="{DynamicResource tabHeaderTroubleshooting}" FontSize="28" FontWeight="Bold" Foreground="{DynamicResource HeaderTextBrush}"/>
                                <TextBlock Text="{DynamicResource appDescription}" FontSize="14" Foreground="{DynamicResource SubTextBrush}" Margin="0,5,0,0"/>
                            </StackPanel>

                            <!-- Installation Status Card -->
                            <Border Grid.Row="1" Style="{StaticResource ModernCard}" Margin="0,0,0,20">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <Border Width="48" Height="48" CornerRadius="24" Background="{DynamicResource AccentGlowBrush}" Margin="0,0,20,0">
                                        <Path Data="{StaticResource Icon.Shield}" Fill="{DynamicResource AccentBrush}" Width="24" Height="24" Stretch="Uniform"/>
                                    </Border>

                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <TextBlock Text="{DynamicResource blitzInstallationStatusHeader}" FontWeight="Bold" FontSize="16" Foreground="{DynamicResource HeaderTextBrush}"/>
                                        <TextBlock Margin="0,2,0,0">
                                            <Run Text="{DynamicResource statusLabel}" Foreground="{DynamicResource SubTextBrush}"/>
                                            <Run FontWeight="SemiBold">
                                                <Run.Style>
                                                    <Style TargetType="Run">
                                                        <Setter Property="Text" Value="{DynamicResource blitzStatusNotInstalled}" />
                                                        <Setter Property="Foreground" Value="{DynamicResource SubTextBrush}" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding BlitzInstallation.Status}" Value="Installed">
                                                                <Setter Property="Text" Value="{DynamicResource blitzStatusInstalled}" />
                                                                <Setter Property="Foreground" Value="{DynamicResource SuccessBrush}" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding BlitzInstallation.Status}" Value="Corrupted">
                                                                <Setter Property="Text" Value="{DynamicResource blitzStatusCorrupted}" />
                                                                <Setter Property="Foreground" Value="{DynamicResource WarningBrush}" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Run.Style>
                                            </Run>
                                            <Run Text="{DynamicResource txtSeparator}" Foreground="{DynamicResource BorderBrush}" />
                                            <Run Text="{DynamicResource versionLabel}" Foreground="{DynamicResource SubTextBrush}"/>
                                            <Run Text="{Binding BlitzInstallation.Version, FallbackValue='N/A'}" FontWeight="SemiBold" Foreground="{DynamicResource HeaderTextBrush}"/>
                                        </TextBlock>
                                        <TextBlock Text="{Binding BlitzInstallation.InstallPath}" FontSize="12" Foreground="{DynamicResource SubTextBrush}" Margin="0,4,0,0"
                                                   Visibility="{Binding BlitzInstallation.HasAnyFiles, Converter={StaticResource BoolToVisConverter}}"/>
                                    </StackPanel>

                                    <Button Grid.Column="2" Content="{StaticResource Icon.Refresh}" Style="{StaticResource TitleBarButton}" 
                                            Command="{Binding RefreshBlitzInstallationCommand}" ToolTip="{DynamicResource tooltipRefreshStatus}"
                                            VerticalAlignment="Center"/>
                                </Grid>
                            </Border>

                            <!-- Action Cards -->
                            <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                                <WrapPanel Margin="-10">
                                    <!-- Fix All Issues -->
                                    <Border Style="{StaticResource ModernCard}" Width="280">
                                        <StackPanel>
                                            <Path Data="{StaticResource Icon.Check}" Fill="{DynamicResource SuccessBrush}" Width="32" Height="32" Stretch="Uniform" HorizontalAlignment="Left" Margin="0,0,0,15"/>
                                            <TextBlock Text="{DynamicResource hdrFixAllIssues}" FontSize="18" FontWeight="Bold" Foreground="{DynamicResource HeaderTextBrush}"/>
                                            <TextBlock Text="{DynamicResource descFixAllIssues}" TextWrapping="Wrap" Margin="0,8,0,20" Height="40" Foreground="{DynamicResource SubTextBrush}"/>
                                            <Button Content="{DynamicResource btnQuickFix}" Style="{StaticResource ModernActionButton}" Command="{Binding FixAllIssuesCommand}" IsEnabled="{Binding IsOperationInProgress, Converter={StaticResource InverseBoolConverter}}"/>
                                        </StackPanel>
                                    </Border>

                                    <!-- Clear Cache -->
                                    <Border Style="{StaticResource ModernCard}" Width="280">
                                        <StackPanel>
                                            <Path Data="{StaticResource Icon.Trash}" Fill="{DynamicResource WarningBrush}" Width="32" Height="32" Stretch="Uniform" HorizontalAlignment="Left" Margin="0,0,0,15"/>
                                            <TextBlock Text="{DynamicResource hdrClearCache}" FontSize="18" FontWeight="Bold" Foreground="{DynamicResource HeaderTextBrush}"/>
                                            <TextBlock Text="{DynamicResource descClearCache}" TextWrapping="Wrap" Margin="0,8,0,20" Height="40" Foreground="{DynamicResource SubTextBrush}"/>
                                            <Button Content="{DynamicResource btnCleanCache}" Style="{StaticResource ModernActionButton}" Command="{Binding ClearCacheCommand}" IsEnabled="{Binding IsOperationInProgress, Converter={StaticResource InverseBoolConverter}}"/>
                                        </StackPanel>
                                    </Border>

                                    <!-- Terminate Processes -->
                                    <Border Style="{StaticResource ModernCard}" Width="280">
                                        <StackPanel>
                                            <Path Data="{StaticResource Icon.Close}" Fill="{DynamicResource ErrorBrush}" Width="32" Height="32" Stretch="Uniform" HorizontalAlignment="Left" Margin="0,0,0,15"/>
                                            <TextBlock Text="{DynamicResource hdrKillProcesses}" FontSize="18" FontWeight="Bold" Foreground="{DynamicResource HeaderTextBrush}"/>
                                            <TextBlock Text="{DynamicResource descKillProcesses}" TextWrapping="Wrap" Margin="0,8,0,20" Height="40" Foreground="{DynamicResource SubTextBrush}"/>
                                            <Button Content="{DynamicResource btnTerminate}" Style="{StaticResource ModernActionButton}" Command="{Binding TerminateProcessesCommand}" IsEnabled="{Binding IsOperationInProgress, Converter={StaticResource InverseBoolConverter}}"/>
                                        </StackPanel>
                                    </Border>

                                    <!-- Download Portable -->
                                    <Border Style="{StaticResource ModernCard}" Width="280">
                                        <StackPanel>
                                            <Path Data="{StaticResource Icon.Download}" Fill="{DynamicResource AccentBrush}" Width="32" Height="32" Stretch="Uniform" HorizontalAlignment="Left" Margin="0,0,0,15"/>
                                            <TextBlock Text="{DynamicResource hdrPortableVersion}" FontSize="18" FontWeight="Bold" Foreground="{DynamicResource HeaderTextBrush}"/>
                                            <TextBlock Text="{DynamicResource descPortableVersion}" TextWrapping="Wrap" Margin="0,8,0,20" Height="40" Foreground="{DynamicResource SubTextBrush}"/>
                                            <Button Content="{DynamicResource btnDownload}" Style="{StaticResource ModernActionButton}" Command="{Binding DownloadPortableCommand}" IsEnabled="{Binding IsOperationInProgress, Converter={StaticResource InverseBoolConverter}}"/>
                                        </StackPanel>
                                    </Border>
                                </WrapPanel>
                            </ScrollViewer>
                        </Grid>
                    </TabItem>

                    <!-- Games View -->
                    <TabItem>
                         <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Margin="0,0,0,30">
                                <TextBlock Text="{DynamicResource tabHeaderRunningGames}" FontSize="28" FontWeight="Bold" Foreground="{DynamicResource HeaderTextBrush}"/>
                                <TextBlock Text="{DynamicResource descRunningGames}" FontSize="14" Foreground="{DynamicResource SubTextBrush}" Margin="0,5,0,0"/>
                            </StackPanel>

                            <Border Grid.Row="1" Style="{StaticResource ModernCard}" Padding="0">
                                <Grid>
                                    <ListView ItemsSource="{Binding RunningGames}" 
                                              Background="Transparent" BorderThickness="0"
                                              Padding="10">
                                        <ListView.ItemTemplate>
                                            <DataTemplate>
                                                <Border Background="{DynamicResource PanelHoverBackgroundBrush}" 
                                                        Margin="5" Padding="15,10" CornerRadius="6">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>
                                                        <Path Data="{StaticResource Icon.Games}" Fill="{DynamicResource SuccessBrush}" Width="20" Height="20" Stretch="Uniform" Margin="0,0,15,0"/>
                                                        <TextBlock Grid.Column="1" Text="{Binding}" FontSize="16" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                                        <TextBlock Grid.Column="2" Text="{DynamicResource statusRunning}" Foreground="{DynamicResource SuccessBrush}" FontWeight="Black" FontSize="10" VerticalAlignment="Center" Margin="10,0,0,0"/>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ListView.ItemTemplate>
                                    </ListView>

                                    <!-- Empty State -->
                                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                                                Visibility="{Binding RunningGames.Count, Converter={StaticResource CollectionEmptyToVisibilityConverter}}">
                                        <Path Data="{StaticResource Icon.Alert}" Fill="{DynamicResource BorderBrush}" Width="48" Height="48" Stretch="Uniform" Margin="0,0,0,15"/>
                                        <TextBlock Text="{DynamicResource hdrNoGamesDetected}" FontSize="18" FontWeight="Bold" Foreground="{DynamicResource SubTextBrush}" HorizontalAlignment="Center"/>
                                        <TextBlock Text="{DynamicResource descNoGamesDetected}" Foreground="{DynamicResource SubTextBrush}" HorizontalAlignment="Center"/>
                                    </StackPanel>
                                </Grid>
                            </Border>

                            <Button Grid.Row="2" Content="{DynamicResource btnScanGames}" Style="{StaticResource ModernActionButton}" 
                                    Command="{Binding RefreshRunningGamesCommand}"
                                    HorizontalAlignment="Right" Margin="0,20,0,0"/>
                        </Grid>
                    </TabItem>
                </TabControl>
            </Grid>

            <!-- Status & Progress -->
            <Border Grid.Column="1" Grid.Row="2" Background="{DynamicResource SidebarBackgroundBrush}" 
                    BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0" Padding="20,10">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="200"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <Path Data="{StaticResource Icon.Info}" Fill="{DynamicResource SubTextBrush}" Width="14" Height="14" Stretch="Uniform" Margin="0,0,10,0"/>
                        <TextBlock Text="{Binding StatusMessage}" FontSize="12" Foreground="{DynamicResource SubTextBrush}" VerticalAlignment="Center"/>
                    </StackPanel>

                    <ProgressBar Grid.Column="1" Height="6" VerticalAlignment="Center"
                                 Value="{Binding ProgressValue}"
                                 Visibility="{Binding IsOperationInProgress, Converter={StaticResource BoolToVisConverter}}"
                                 Style="{StaticResource {x:Type ProgressBar}}"
                                 Background="{DynamicResource PanelBackgroundBrush}"
                                 Foreground="{DynamicResource AccentBrush}"
                                 BorderThickness="0"/>
                </Grid>
            </Border>
        </Grid>
    </Border>

</Window>
